{% extends 'base.html' %}
{% load static %}

{% block banner_slider %}
{% endblock banner_slider %}

{% block cart-content %}
<div class="row">
    <section id="cart-container" class="container my-5">
        <table width="100%">
            <thead>
                <tr>
                    <td>Remove</td>
                    <td>Image</td>
                    <td>Product</td>
                    <td>Price</td>
                    <td>Quantity</td>
                    <td>Size</td>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                <tr id="cart-item-{{ item.id }}">
                    <td><button onclick="removeFromCart({{ item.id }})"><i class="fas fa-trash-alt"></i></button></td>
                    <td><img src="/static/{{ item.product.image }}" alt="{{ item.product.name }}"></td>
                    <td>
                        <p class="product-name">{{ item.product.name }}</p>
                    </td>
                    <td>
                        <h5>{{ item.product.price }} VNĐ</h5>
                    </td>
                    <td>{{ item.quantity }}</td>
                    <td>
                        <h5>{{ item.size }}</h5>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    <div class="total col-lg-6 col-md-6 col-12">
        <div>
          <h5>CART TOTAL</h5>
          <hr class="second-hr">
          <div class="d-flex justify-content-between">
            <h6>Total</h6>
            <p id="cart-total-price">{{ total_price }} VNĐ</p>
          </div>
          <button  onclick="payment()">THANH TOÁN</button>
        </div>
    </div>
</div>

<style>
    #cart-container {
        overflow-x: auto;
    }
    #cart-container table {
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
        white-space: nowrap;
    }
    #cart-container table thead {
        font-weight: 700;
    }
    #cart-container table thead td {
        background: #fd8c66;
        color: #fff;
        border: none;
        padding: 6px 0;
    }
    #cart-container table td {
        border: 1px solid #b6b3b3;
        text-align: center;
    }
    #cart-container table td:nth-child(1) {
        width: 100px;
    }
    #cart-container table td:nth-child(2),
    #cart-container table td:nth-child(3) {
        width: 200px;
    }
    #cart-container table td:nth-child(4),
    #cart-container table td:nth-child(5), 
    #cart-container table td:nth-child(6) {
        width: 170px;
    }
    #cart-container table tbody img {
        width: 100px;
        height: 80px;
        object-fit: cover;
    }
    #cart-container table tbody i {
        color: #8d8c89;
    }
    .second-hr {
        background: #b8b7b3;
        width: 100%;
        height: 1px;
    }

    .product-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 200px; /* Adjust to match the width of the column */
        margin: 0 auto; /* Center the text within the cell */
    }
</style>
<script>
    function removeFromCart(itemId) {
        if (confirm("Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?")) {
            fetch(`/remove_from_cart/${itemId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'  // Thêm CSRF token vào header của yêu cầu
                }
            })
            .then(response => {
                if (response.ok) {
                    // Xóa sản phẩm khỏi DOM
                    let row = document.getElementById(`cart-item-${itemId}`);
                    row.parentNode.removeChild(row);
                    recalculateCartTotal();
                } else {
                    console.error('Xóa sản phẩm thất bại.');
                }
            })
            .catch(error => {
                console.error('Lỗi:', error);
            });
        }
    }
    function recalculateCartTotal() {
        fetch('/recalculate_cart_total/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'  // Thêm CSRF token vào header của yêu cầu
            }
        })
        .then(response => response.json())
        .then(data => {
            // Cập nhật lại tổng giá trị trong DOM
            document.querySelector('#cart-total-price').textContent = `${data.total_price} VNĐ`;
        })
        .catch(error => {
            console.error('Lỗi khi tính toán lại tổng giá trị giỏ hàng:', error);
        });
    }
    function payment() {
        fetch('/payment/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'  // Thêm CSRF token vào header của yêu cầu
            }
        })
        .then(response => {
            window.location.href = '/cart';
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Lỗi khi gửi yêu cầu thanh toán');
            }
        })
        .then(data => {
            // Cập nhật lại tổng giá trị trong DOM
            document.querySelector('#cart-total-price').textContent = `${data.total_price} VNĐ`;
            // Hiển thị thông báo thành công
            alert('Thanh toán thành công!');
        })
        .catch(error => {
            console.error('Lỗi khi thực hiện thanh toán:', error);
            // Hiển thị thông báo lỗi
            showAlert('Có lỗi xảy ra trong quá trình thanh toán. Vui lòng thử lại sau.');
        });
    }
    
</script>
{% endblock cart-content %}
